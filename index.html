<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Diaria ‚Äî v3.2 Responsive</title>
  <link rel="stylesheet" href="./style.css" />


</head>

<body class="layout">
  <aside class="sidebar expanded" id="sidebar">
    <div class="brand">LD v3.2</div>
    <button data-view="day"><span>üè†</span><i>Panel del d√≠a</i></button>
    <button data-view="hypo"><span>üß©</span><i>Hip√≥tesis</i></button>
    <button data-view="analysis"><span>üìä</span><i>Escenarios</i></button>
    <button data-view="geometry"><span>‚ú¥Ô∏è</span><i>Cruceta/Tri√°ngulo</i></button>
    <button data-view="memory"><span>üß†</span><i>Memoria</i></button>
    <button data-view="guide"><span>üìò</span><i>Gu√≠a de los Sue√±os</i></button>
    <button data-view="config"><span>‚öôÔ∏è</span><i>Configuraci√≥n</i></button>
    <button data-view="maint"><span>üõ†Ô∏è</span><i>Mantenimiento</i></button>
  </aside>

  <main class="content">
    <header class="top">
      <h1>Sistema</h1>
      <button id="btn-toggle-sidebar" class="menu-btn">‚ò∞</button>
      <div class="badge">v3.2 ‚Ä¢ Oscuro + Dorado</div>
    </header>

    <!-- PANEL DEL D√çA -->
    <section id="view-day" class="view">
      <h2>Panel del d√≠a</h2>
      <div class="row">
        <label>Fecha <input type="date" id="day-fecha" /></label>
        <label>Pa√≠s
          <select id="day-pais">
            <option>HN</option>
            <option>NI</option>
            <option>SV</option>
          </select>
        </label>
      </div>

      <div class="triple">
        <div class="slot">
          <div class="slot-title">11 AM</div>
          <div class="ball-row">
            <div class="ball" id="b-11">--</div>
            <div class="sym" id="s-11"></div>
          </div>
          <div class="row">
            <input id="n-11" placeholder="00-99" />
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="test-11" /> Modo prueba
            </label>
            <button id="save-11">Guardar</button>
          </div>
          <button class="ghost" data-hypo="11AM">Agregar hip√≥tesis para 11 AM</button>
        </div>

        <div class="slot">
          <div class="slot-title">3 PM</div>
          <div class="ball-row">
            <div class="ball" id="b-3">--</div>
            <div class="sym" id="s-3"></div>
          </div>
          <div class="row">
            <input id="n-3" placeholder="00-99" />
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="test-3" /> Modo prueba
            </label>
            <button id="save-3">Guardar</button>
          </div>
          <button class="ghost" data-hypo="3PM">Agregar hip√≥tesis para 3 PM</button>
        </div>

        <div class="slot">
          <div class="slot-title">9 PM</div>
          <div class="ball-row">
            <div class="ball" id="b-9">--</div>
            <div class="sym" id="s-9"></div>
          </div>
          <div class="row">
            <input id="n-9" placeholder="00-99" />
            <label style="display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="test-9" /> Modo prueba
            </label>
            <button id="save-9">Guardar</button>
          </div>
          <button class="ghost" data-hypo="9PM">Agregar hip√≥tesis para 9 PM</button>
        </div>
      </div>

      <div class="row" style="margin-top:20px;">
        <button id="btn-aprender-dia">Registrar resultados del d√≠a (aprendizaje)</button>
        <span class="hint">
          Confirma/Refuta hip√≥tesis pendientes seg√∫n los resultados v√°lidos de la fecha seleccionada.
        </span>
      </div>
    </section>

    <!-- HIP√ìTESIS -->
    <section id="view-hypo" class="view hidden">
      <h2>Hip√≥tesis manuales</h2>
      <div class="row">
        <label>Fecha <input type="date" id="h-fecha" /></label>
        <label>Turno
          <select id="h-turno">
            <option>11AM</option>
            <option>3PM</option>
            <option>9PM</option>
          </select>
        </label>
        <label>N√∫mero <input id="h-numero" placeholder="00-99" /></label>
      </div>
      <div class="row">
        <label style="flex:1">
          Texto / Raz√≥n
          <textarea id="h-texto" rows="3" placeholder="Describe tu hip√≥tesis..."></textarea>
        </label>
      </div>
      <button id="h-guardar">Guardar hip√≥tesis</button>
      <h3>Historial</h3>
      <div id="h-list"></div>
    </section>

    <!-- ESCENARIOS -->
    <section id="view-analysis" class="view hidden">
      <h2>Escenarios y recomendaci√≥n</h2>
      <button id="btn-analizar">Analizar</button>
      <p class="hint">
        La <b>confianza (conf)</b> es una ponderaci√≥n heur√≠stica (0‚Äì100%).
      </p>
      <div class="cards" id="result-escenarios"></div>
      <div class="cards" id="result-recomendacion"></div>

      <div id="transform-panel" class="card">
        <div class="card-head">üîÑ Transformaciones Visuales</div>
        <div class="row">
          <input id="t-numero" placeholder="Ej. 25" />
          <button id="t-ver">Ver transformaciones</button>
        </div>
        <div id="t-output"></div>
      </div>
    </section>

    <!-- GEOMETR√çA -->
    <section id="view-geometry" class="view hidden">
      <h2>Cruceta / Tri√°ngulo (visual)</h2>
      <div class="row">
        <label>Fecha <input type="date" id="g-fecha" /></label>
        <button id="g-generar">Generar</button>
      </div>
      <div class="geom-wrap">
        <div class="geom-card">
          <h3>Cruceta</h3>
          <div id="g-cruceta" class="cruceta"></div>
        </div>
        <div class="geom-card">
          <h3>Tri√°ngulo invertido</h3>
          <div id="g-tri" class="tri"></div>
        </div>
      </div>
    </section>

    <!-- MEMORIA -->
    <section id="view-memory" class="view hidden">
      <h2>Memoria simb√≥lica</h2>
      <button id="toggle-tech">Mostrar/Ocultar modo t√©cnico</button>
      <pre id="mem-out" class="hidden"></pre>
    </section>

    <!-- GU√çA -->
    <section id="view-guide" class="view hidden">
      <h2>Gu√≠a de los Sue√±os</h2>
      <p class="hint">
        Explora todos los n√∫meros (00‚Äì99), sus s√≠mbolos, familias y polaridades. <br />
        Los espacios vac√≠os est√°n reservados para las im√°genes futuras de cada s√≠mbolo.
      </p>
      <div id="guide-grid" class="guide-grid"></div>
    </section>

    <!-- CONFIGURACI√ìN -->
    <section id="view-config" class="view hidden">
      <h2>Configuraci√≥n</h2>
      <p>‚Ä¢ Sidebar expandido con nombres.</p>
      <p>‚Ä¢ Tema oscuro con acentos dorados y esferas animadas.</p>
    </section>

    <!-- MANTENIMIENTO -->
    <section id="view-maint" class="view hidden">
      <h2>Mantenimiento</h2>
      <div class="card">
        <div class="card-head">Duplicados</div>
        <div class="row">
          <button id="btn-list-dup">Revisar duplicados</button>
          <button id="btn-marktest-dup">Marcar seleccionados como modo prueba</button>
          <button id="btn-delete-dup">Eliminar seleccionados</button>
        </div>
        <div id="dup-out" class="card-body"></div>
      </div>
      <div class="card" style="margin-top:15px;">
        <div class="card-head">Todos los sorteos registrados</div>
        <div class="row">
          <button id="btn-list-all">Ver todos</button>
        </div>
        <div id="all-out" class="card-body"></div>
      </div>
      <div class="card" style="margin-top:15px;">
        <div class="card-head">Reiniciar base de datos</div>
        <div class="row">
          <button id="btn-nuke" style="background:#e04c41;border-color:#e04c41;color:#fff;">
            ‚ö†Ô∏è Borrar todo (reiniciar)
          </button>
        </div>
        <p class="hint">Usa con precauci√≥n: eliminar√° todos los sorteos, hip√≥tesis y reglas.</p>
      </div>


    </section>
  </main>

  <script type="module">
    import { mostrarGuia } from "./src/guide-grid.js";
    import { DB } from "./src/storage.js";
    import { importarManual } from "./src/importer.js";
    import { crearHipotesis, registrarResultado } from "./src/narrative.js";
    import { analizarYProponer } from "./src/reasoning.js";
    import { generarCruceta, generarTrianguloInvertido, dibujarTrianguloInvertido } from "./src/geometry.js";
    import { cargarGuia, GUIA, getColorPolaridad } from "./src/loader.js";
    import { detectarPatrones } from "./src/pattern-detector.js";
    import { revisarDuplicados, marcarGrupoComoTest, borrarIds } from "./src/maintenance.js";
    import { mostrarTransformaciones } from "./src/transform-visual.js";

    await cargarGuia();

    const todayISO = new Date().toISOString().slice(0, 10);
    ["day-fecha", "h-fecha", "g-fecha"].forEach((id) => {
      const el = document.getElementById(id);
      if (el && !el.value) el.value = todayISO;
    });

    const SLOT_CONFIG = [
      {
        key: "11AM",
        inputId: "n-11",
        buttonId: "save-11",
        checkboxId: "test-11",
        ballId: "b-11",
        symId: "s-11",
      },
      {
        key: "3PM",
        inputId: "n-3",
        buttonId: "save-3",
        checkboxId: "test-3",
        ballId: "b-3",
        symId: "s-3",
      },
      {
        key: "9PM",
        inputId: "n-9",
        buttonId: "save-9",
        checkboxId: "test-9",
        ballId: "b-9",
        symId: "s-9",
      },
    ];

    const formatNumber = (n) => String(n).padStart(2, "0");

    const getSymbol = (numero) => {
      const entry = GUIA[formatNumber(numero)];
      return entry?.simbolo || "";
    };

    const getFilters = () => ({
      fecha: document.getElementById("day-fecha")?.value,
      pais: document.getElementById("day-pais")?.value,
    });

    function pickDraw(draws, fecha, pais, horario) {
      if (!fecha || !pais) return null;
      const matching = draws
        .filter((d) => d.fecha === fecha && d.pais === pais && d.horario === horario)
        .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
      if (!matching.length) return null;
      return matching
        .slice()
        .reverse()
        .find((d) => !d.isTest) ?? matching[matching.length - 1];
    }

    function applyDrawToSlot(config, draw) {
      const ball = document.getElementById(config.ballId);
      const sym = document.getElementById(config.symId);
      if (!ball || !sym) return;
      if (!draw) {
        ball.textContent = "--";
        ball.classList.remove("small");
        ball.removeAttribute("data-numero");
        ball.style.borderColor = "";
        ball.style.color = "";
        sym.textContent = "";
        sym.removeAttribute("title");
        return;
      }
      const numero = formatNumber(draw.numero);
      const color = getColorPolaridad(draw.numero);
      ball.textContent = numero;
      ball.dataset.numero = numero;
      ball.classList.toggle("small", !!draw.isTest);
      ball.style.borderColor = color;
      ball.style.color = color;
      sym.textContent = getSymbol(draw.numero);
      sym.title = draw.isTest ? "Modo prueba" : sym.textContent || "";
    }

    async function refreshSlots() {
      const { fecha, pais } = getFilters();
      const draws = await DB.listDraws({ excludeTest: false });
      SLOT_CONFIG.forEach((config) => {
        const draw = pickDraw(draws, fecha, pais, config.key);
        applyDrawToSlot(config, draw);
      });
    }

    SLOT_CONFIG.forEach((config) => {
      const btn = document.getElementById(config.buttonId);
      if (!btn) return;
      btn.addEventListener("click", async () => {
        const { fecha, pais } = getFilters();
        if (!fecha || !pais) {
          alert("Selecciona fecha y pa√≠s antes de guardar.");
          return;
        }
        const input = document.getElementById(config.inputId);
        const raw = input?.value.trim() ?? "";
        if (!/^\d{1,2}$/.test(raw)) {
          alert("Ingresa un n√∫mero v√°lido (00-99).");
          return;
        }
        const numero = parseInt(raw, 10);
        if (numero < 0 || numero > 99) {
          alert("El n√∫mero debe estar entre 00 y 99.");
          return;
        }
        const testCheck = document.getElementById(config.checkboxId);
        const opts = testCheck?.checked ? { source: "test" } : {};
        try {
          await importarManual({ fecha, pais, horario: config.key, numero }, opts);
          input.value = "";
          if (testCheck) testCheck.checked = false;
          await refreshSlots();
        } catch (err) {
          console.error("saveDraw error", err);
          alert(`No se pudo guardar el sorteo: ${err.message}`);
        }
      });
    });

    const dayFecha = document.getElementById("day-fecha");
    const dayPais = document.getElementById("day-pais");
    dayFecha?.addEventListener("change", refreshSlots);
    dayPais?.addEventListener("change", refreshSlots);

    const btnAprender = document.getElementById("btn-aprender-dia");
    btnAprender?.addEventListener("click", async () => {
      const { fecha, pais } = getFilters();
      if (!fecha || !pais) {
        alert("Selecciona fecha y pa√≠s para procesar el aprendizaje.");
        return;
      }
      const draws = (await DB.listDraws({ excludeTest: true })).filter(
        (d) => d.fecha === fecha && d.pais === pais
      );
      if (!draws.length) {
        alert("No hay sorteos reales registrados para esa fecha y pa√≠s.");
        return;
      }
      try {
        for (const draw of draws) {
          const simbolo = getSymbol(draw.numero);
          await registrarResultado(draw.numero, simbolo);
        }
        await refreshHypotesis();
        alert("Hip√≥tesis actualizadas con los resultados del d√≠a.");
      } catch (err) {
        console.error("aprendizaje error", err);
        alert(`Error al registrar resultados: ${err.message}`);
      }
    });

    async function refreshHypotesis() {
      const cont = document.getElementById("h-list");
      if (!cont) return;
      const hyps = await DB._getAll("hypotheses");
      if (!hyps.length) {
        cont.innerHTML = "<p class='hint'>A√∫n no hay hip√≥tesis registradas.</p>";
        return;
      }
      hyps.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      cont.innerHTML = "";
      for (const h of hyps) {
        const card = document.createElement("div");
        card.className = "card";
        const estado = h.estado || "pendiente";
        const fecha = h.fecha || "(sin fecha)";
        const turno = h.turno || "";
        const razones = (h.razones || []).filter(Boolean).join(" ¬∑ ") || "Sin notas";
        card.innerHTML = `
          <div class="card-head">${formatNumber(h.numero)} ${h.simbolo || getSymbol(h.numero)
          } ¬∑ <span style="text-transform:capitalize">${estado}</span></div>
          <div class="card-body" style="flex-direction:column;align-items:flex-start;gap:6px;">
            <span class="hint">Fecha: ${fecha} ${turno ? "‚Ä¢ " + turno : ""}</span>
            <span class="hint">Notas: ${razones}</span>
          </div>
        `;
        cont.appendChild(card);
      }
    }

    const btnHipotesis = document.getElementById("h-guardar");
    btnHipotesis?.addEventListener("click", async () => {
      const fecha = document.getElementById("h-fecha")?.value;
      const turno = document.getElementById("h-turno")?.value;
      const numeroRaw = document.getElementById("h-numero")?.value.trim() ?? "";
      const texto = document.getElementById("h-texto")?.value.trim() ?? "";
      if (!/^\d{1,2}$/.test(numeroRaw)) {
        alert("Ingresa un n√∫mero v√°lido (00-99) para la hip√≥tesis.");
        return;
      }
      const numero = parseInt(numeroRaw, 10);
      try {
        await crearHipotesis(numero, getSymbol(numero), texto, { fecha, turno });
        const txt = document.getElementById("h-texto");
        if (txt) txt.value = "";
        await refreshHypotesis();
        alert("Hip√≥tesis guardada.");
      } catch (err) {
        console.error("crearHipotesis error", err);
        alert(`No se pudo guardar la hip√≥tesis: ${err.message}`);
      }
    });

    const btnAnalizar = document.getElementById("btn-analizar");
    const resultEscenarios = document.getElementById("result-escenarios");
    const resultRecomendacion = document.getElementById("result-recomendacion");

    btnAnalizar?.addEventListener("click", async () => {
      if (resultEscenarios) resultEscenarios.innerHTML = "<p class='hint'>Analizando‚Ä¶</p>";
      if (resultRecomendacion) resultRecomendacion.innerHTML = "";
      try {
        const analisis = await analizarYProponer(GUIA);
        const patrones = await detectarPatrones();

        renderEscenarios(analisis.escenarios || [], patrones);
        renderRecomendaciones(analisis.recomendacion || [], analisis.nota);
      } catch (err) {
        console.error("analizar error", err);
        if (resultEscenarios)
          resultEscenarios.innerHTML = `<p class='hint'>No se pudo completar el an√°lisis: ${err.message}</p>`;
      }
    });

    function renderEscenarios(escenarios, patrones) {
      if (!resultEscenarios) return;
      resultEscenarios.innerHTML = "";
      if (patrones?.mensaje) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-head">Tendencias recientes</div>
          <div class="card-body" style="flex-direction:column;gap:6px;align-items:flex-start;">
            <span class="hint">${patrones.mensaje}</span>
          </div>
        `;
        resultEscenarios.appendChild(card);
      }
      if (!escenarios.length) {
        resultEscenarios.innerHTML += "<p class='hint'>No hay escenarios disponibles. Registra sorteos para obtener proyecciones.</p>";
        return;
      }
      for (const esc of escenarios) {
        const card = document.createElement("div");
        card.className = "card";
        const conf = Math.round((esc.confianza || 0) * 100);
        const body = document.createElement("div");
        body.className = "card-body";
        body.style.flexDirection = "column";
        body.style.gap = "6px";
        body.style.alignItems = "flex-start";
        const lista = document.createElement("div");
        lista.style.display = "flex";
        lista.style.flexWrap = "wrap";
        lista.style.gap = "8px";
        for (const cand of esc.candidatos || []) {
          const pill = document.createElement("div");
          pill.className = "pill gold";
          pill.style.borderColor = getColorPolaridad(cand.numero);
          pill.innerHTML = `<span>${formatNumber(cand.numero)}</span><span>${cand.simbolo || getSymbol(cand.numero) || ""
            }</span>`;
          pill.title = (cand.razones || []).join(" ¬∑ ") || "";
          lista.appendChild(pill);
        }
        card.innerHTML = `
          <div class="card-head">${esc.nombre || "Escenario"} ‚Äî conf ${conf}%</div>
        `;
        body.appendChild(lista);
        if (esc.explicacion) {
          const hint = document.createElement("span");
          hint.className = "hint";
          hint.textContent = esc.explicacion;
          body.appendChild(hint);
        }
        card.appendChild(body);
        resultEscenarios.appendChild(card);
      }
    }

    function renderRecomendaciones(recomendacion, nota) {
      if (!resultRecomendacion) return;
      resultRecomendacion.innerHTML = "";
      if (!recomendacion.length) {
        resultRecomendacion.innerHTML = "<p class='hint'>Sin recomendaciones por el momento.</p>";
        return;
      }
      const card = document.createElement("div");
      card.className = "card";
      const body = document.createElement("div");
      body.className = "card-body";
      body.style.display = "flex";
      body.style.flexWrap = "wrap";
      body.style.gap = "10px";
      for (const cand of recomendacion) {
        const pill = document.createElement("div");
        pill.className = "pill gold";
        pill.style.borderColor = getColorPolaridad(cand.numero);
        pill.innerHTML = `<span>${formatNumber(cand.numero)}</span><span>${cand.simbolo || getSymbol(cand.numero) || ""
          }</span>`;
        pill.title = (cand.razones || []).join(" ¬∑ ") || "";
        body.appendChild(pill);
      }
      if (nota) {
        const hint = document.createElement("span");
        hint.className = "hint";
        hint.textContent = nota;
        body.appendChild(hint);
      }
      card.innerHTML = `<div class="card-head">Recomendaci√≥n consolidada</div>`;
      card.appendChild(body);
      resultRecomendacion.appendChild(card);
    }

    const toggleTech = document.getElementById("toggle-tech");
    const memOut = document.getElementById("mem-out");
    toggleTech?.addEventListener("click", async () => {
      if (!memOut) return;
      memOut.classList.toggle("hidden");
      if (!memOut.classList.contains("hidden")) {
        const draws = await DB.listDraws({ excludeTest: false });
        memOut.textContent = JSON.stringify(draws.slice(-50), null, 2);
      }
    });

    const btnTransform = document.getElementById("t-ver");
    btnTransform?.addEventListener("click", () => {
      const raw = document.getElementById("t-numero")?.value.trim() ?? "";
      const numero = parseInt(raw, 10);
      mostrarTransformaciones(numero);
    });

    const btnGeometria = document.getElementById("g-generar");
    btnGeometria?.addEventListener("click", () => {
      const fecha = document.getElementById("g-fecha")?.value;
      if (!fecha) {
        alert("Selecciona una fecha para generar la cruceta/tri√°ngulo.");
        return;
      }
      const cruceta = generarCruceta(fecha);
      renderCruceta(cruceta);
      const niveles = generarTrianguloInvertido(fecha);
      const contTri = document.getElementById("g-tri");
      if (contTri) dibujarTrianguloInvertido(contTri, niveles);
    });

    function renderCruceta(data) {
      const cont = document.getElementById("g-cruceta");
      if (!cont) return;
      cont.innerHTML = `
        <div class="c-row">
          <div class="ball small">${formatNumber(data.norte)}</div>
        </div>
        <div class="c-row">
          <div class="ball small">${formatNumber(data.oeste)}</div>
          <div class="ball small">${formatNumber(data.centro)}</div>
          <div class="ball small">${formatNumber(data.este)}</div>
        </div>
        <div class="c-row">
          <div class="ball small">${formatNumber(data.sur)}</div>
        </div>
      `;
    }

    const btnDup = document.getElementById("btn-list-dup");
    const btnMarkTestDup = document.getElementById("btn-marktest-dup");
    const btnDeleteDup = document.getElementById("btn-delete-dup");
    const dupOut = document.getElementById("dup-out");

    btnDup?.addEventListener("click", refreshDuplicados);

    btnMarkTestDup?.addEventListener("click", async () => {
      const ids = getSelectedDupIds();
      if (!ids.length) {
        alert("Selecciona al menos un registro duplicado.");
        return;
      }
      try {
        await marcarGrupoComoTest(ids);
        await refreshDuplicados();
        await refreshSlots();
      } catch (err) {
        console.error("mark dup error", err);
        alert(`No se pudo marcar como prueba: ${err.message}`);
      }
    });

    btnDeleteDup?.addEventListener("click", async () => {
      const ids = getSelectedDupIds();
      if (!ids.length) {
        alert("Selecciona registros para eliminar.");
        return;
      }
      if (!confirm("¬øEliminar los registros seleccionados?")) return;
      try {
        await borrarIds(ids);
        await refreshDuplicados();
        await refreshSlots();
      } catch (err) {
        console.error("delete dup error", err);
        alert(`No se pudieron eliminar los registros: ${err.message}`);
      }
    });

    async function refreshDuplicados() {
      if (!dupOut) return;
      dupOut.innerHTML = "<p class='hint'>Buscando duplicados‚Ä¶</p>";
      try {
        const grupos = await revisarDuplicados();
        if (!grupos.length) {
          dupOut.innerHTML = "<p class='hint'>Sin duplicados detectados.</p>";
          return;
        }
        dupOut.innerHTML = "";
        grupos.forEach((group, idx) => {
          const box = document.createElement("div");
          box.className = "card";
          box.style.width = "100%";
          box.style.marginBottom = "10px";
          const head = document.createElement("div");
          head.className = "card-head";
          head.textContent = `Grupo #${idx + 1}`;
          const list = document.createElement("div");
          list.className = "card-body";
          list.style.flexDirection = "column";
          list.style.alignItems = "flex-start";
          group.forEach((reg) => {
            const label = document.createElement("label");
            label.className = "symbol-tag";
            label.innerHTML = `
              <input type="checkbox" value="${reg.id}" />
              <span>${formatNumber(reg.numero)}</span>
              <span>${reg.fecha} ${reg.horario} ${reg.pais}</span>
              <span class="hint">${reg.isTest ? "test" : "real"}</span>
            `;
            list.appendChild(label);
          });
          box.appendChild(head);
          box.appendChild(list);
          dupOut.appendChild(box);
        });
      } catch (err) {
        console.error("dup error", err);
        dupOut.innerHTML = `<p class='hint'>No se pudieron obtener duplicados: ${err.message}</p>`;
      }
    }

    function getSelectedDupIds() {
      if (!dupOut) return [];
      return Array.from(dupOut.querySelectorAll("input[type='checkbox']:checked"))
        .map((el) => parseInt(el.value, 10))
        .filter((n) => !Number.isNaN(n));
    }

    // ‚úÖ Cambio de vistas
    const views = {
      day: "view-day",
      hypo: "view-hypo",
      analysis: "view-analysis",
      geometry: "view-geometry",
      memory: "view-memory",
      guide: "view-guide",
      config: "view-config",
      maint: "view-maint",
    };
    document.querySelectorAll(".sidebar button").forEach((b) => {
      b.onclick = () => {
        document.querySelectorAll(".view").forEach((v) => v.classList.add("hidden"));
        const id = views[b.dataset.view];
        const el = document.getElementById(id);
        if (!el) return console.warn("Vista no encontrada:", id);
        el.classList.remove("hidden");
        if (id === "view-guide") mostrarGuia();
        if (id === "view-hypo") refreshHypotesis();
        if (id === "view-maint") refreshDuplicados();
      };
    });

    // ‚úÖ Toggle de sidebar m√≥vil
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("btn-toggle-sidebar");
    if (toggleBtn && sidebar) {
      toggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("show-mobile");
      });
    }

    await refreshHypotesis();
    await refreshSlots();

    // === SISTEMA DE MODALES UNIFICADO ===
    function mostrarModal(titulo, mensaje, opciones = {}) {
      return new Promise((resolve) => {
        const modal = document.getElementById("sys-modal");
        const tEl = document.getElementById("modal-title");
        const mEl = document.getElementById("modal-msg");
        const okBtn = document.getElementById("modal-ok");
        const cancelBtn = document.getElementById("modal-cancel");

        if (!modal) return resolve(false);

        // Personalizar texto
        tEl.textContent = titulo || "Confirmar acci√≥n";
        mEl.textContent = mensaje || "¬øDeseas continuar?";
        okBtn.textContent = opciones.okText || "Aceptar";
        cancelBtn.textContent = opciones.cancelText || "Cancelar";

        // Mostrar modal
        modal.classList.remove("hidden");

        // Manejo de cierre
        const cerrar = (res) => {
          modal.classList.add("hidden");
          okBtn.onclick = cancelBtn.onclick = null;
          resolve(res);
        };

        okBtn.onclick = () => cerrar(true);
        cancelBtn.onclick = () => cerrar(false);
      });
    }

    // === Notificaci√≥n breve (sin botones, tipo toast simple) ===
    function mostrarAviso(mensaje) {
      const modal = document.getElementById("sys-modal");
      const tEl = document.getElementById("modal-title");
      const mEl = document.getElementById("modal-msg");
      const okBtn = document.getElementById("modal-ok");
      const cancelBtn = document.getElementById("modal-cancel");

      tEl.textContent = "Aviso";
      mEl.textContent = mensaje;
      okBtn.textContent = "Cerrar";
      cancelBtn.style.display = "none";
      modal.classList.remove("hidden");

      okBtn.onclick = () => {
        modal.classList.add("hidden");
        cancelBtn.style.display = "";
      };
    }


    // === NUEVA FUNCI√ìN COMPLETA: Mostrar/Ocultar y eliminar sorteos individualmente ===
    // === Mostrar/Ocultar y eliminar sorteos individualmente (versi√≥n robusta) ===
    const btnListAll = document.getElementById("btn-list-all");
    const allOut = document.getElementById("all-out");

    async function renderAllTable() {
      if (!allOut) return;
      allOut.innerHTML = "<p class='hint'>Cargando todos los sorteos‚Ä¶</p>";

      const draws = await DB.listDraws({ excludeTest: false });
      if (!draws.length) {
        allOut.innerHTML = "<p class='hint'>No hay sorteos registrados a√∫n.</p>";
        return;
      }

      const table = document.createElement("table");
      table.className = "table-history";
      table.innerHTML = `
    <thead>
      <tr>
        <th>#</th><th>Fecha</th><th>Pa√≠s</th><th>Horario</th>
        <th>N√∫mero</th><th>S√≠mbolo</th><th>Tipo</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
      const tbody = table.querySelector("tbody");

      draws.forEach((d, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${d.fecha}</td>
      <td>${d.pais}</td>
      <td>${d.horario}</td>
      <td class="num">${String(d.numero).padStart(2, "0")}</td>
      <td class="sym">${GUIA[String(d.numero).padStart(2, "0")]?.simbolo || "‚Äî"}</td>
      <td class="${d.isTest ? "test" : ""}">${d.isTest ? "prueba" : "real"}</td>
      <td>
        <button type="button" class="btn-del" data-id="${d.id}">üóë</button>
      </td>
    `;
        tbody.appendChild(tr);
      });

      allOut.innerHTML = "";
      allOut.appendChild(table);
    }

    btnListAll?.addEventListener("click", async () => {
      if (!allOut) return;

      // Toggle: ocultar si est√° visible
      if (allOut.dataset.visible === "true") {
        allOut.innerHTML = "";
        allOut.dataset.visible = "false";
        btnListAll.textContent = "Ver todos";
        return;
      }

      // Mostrar
      await renderAllTable();
      allOut.dataset.visible = "true";
      btnListAll.textContent = "Ocultar tabla";
    });

    // üîí Delegaci√≥n de eventos sobre el contenedor (funciona aunque se regenere la tabla)
    allOut?.addEventListener("click", async (ev) => {
      const delBtn = ev.target.closest?.(".btn-del");
      if (!delBtn) return;

      const id = Number(delBtn.dataset.id);
      if (!Number.isFinite(id)) return;

      // Guardar referencias ANTES del modal
      const fila = delBtn.closest("tr");

      const confirmar = await mostrarModal(
        "Eliminar sorteo",
        "¬øSeguro que deseas eliminar este sorteo permanentemente?",
        { okText: "Eliminar", cancelText: "Cancelar" }
      );
      if (!confirmar) return;

      try {
        await DB.deleteDrawById(id);
        if (fila) fila.remove();
        // Si queda la tabla vac√≠a, no forzamos recarga; el usuario puede pulsar "Ocultar" y "Ver todos".
        mostrarAviso("Sorteo eliminado correctamente.");
      } catch (err) {
        console.error("delete draw error", err);
        mostrarAviso(`Error al eliminar: ${err.message}`);
      }
    });



    // === Bot√≥n para reiniciar completamente la base ===
    const btnNuke = document.getElementById("btn-nuke");
    btnNuke?.addEventListener("click", async () => {
      if (!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar TODOS los datos del sistema?")) return;
      try {
        await DB.nuke();
        alert("Base de datos vaciada correctamente. Reinicia la p√°gina para comenzar desde cero.");
      } catch (err) {
        console.error("nuke error", err);
        alert(`Error al intentar limpiar la base: ${err.message}`);
      }
    });

  </script>
  <!-- === MODAL DEL SISTEMA === -->
  <div id="sys-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-head">
        <h3 id="modal-title">Confirmar acci√≥n</h3>
      </div>
      <div class="modal-body">
        <p id="modal-msg"></p>
      </div>
      <div class="modal-foot">
        <button id="modal-cancel">Cancelar</button>
        <button id="modal-ok">Aceptar</button>
      </div>
    </div>
  </div>

</body>

</html>